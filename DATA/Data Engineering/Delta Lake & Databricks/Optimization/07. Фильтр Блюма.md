
**Что такое фильтр Блума?**

Фильтр Блума — это вероятностная структура данных, которая используется для проверки, присутствует ли элемент в наборе. В контексте Delta Lake фильтры Блума используются для оптимизации запросов, позволяя Delta Lake пропускать файлы, которые с большой вероятностью не содержат нужные данные.

**Как это работает?**

1. При записи данных в Delta Lake для определенных столбцов создаются фильтры Блума.
2. Фильтр Блума — это битовый массив, в котором установлены определенные биты на основе значений столбца.
3. При выполнении запроса Delta Lake использует фильтр Блума, чтобы проверить, может ли файл содержать нужные данные.
4. Если фильтр Блума указывает, что файл, вероятно, не содержит нужные данные, Delta Lake пропускает этот файл.

**Сценарии использования:**

- **Столбцы с высокой кардинальностью:** Фильтры Блума наиболее эффективны для столбцов с большим количеством уникальных значений.
- **Запросы с фильтрацией по равенству:** Фильтры Блума хорошо работают для запросов, которые фильтруют данные по равенству (например, `WHERE column = value`).
- **Ускорение запросов:** Фильтры Блума позволяют значительно ускорить запросы, особенно для больших таблиц.

**Совместимость с другими технологиями оптимизации:**

- Фильтры Блума совместимы с другими технологиями оптимизации Delta Lake, такими как z-Ordering и compaction.
- Они могут использоваться вместе для достижения максимальной производительности.

**Примеры кода:**

1. **Создание фильтра Блума:**
    
    - **SQL:**
    
    SQL
    
    ```
    CREATE BLOOMFILTER INDEX
    ON TABLE deltaTableName
    FOR COLUMNS(columnName OPTIONS (fpp=0.01, expectedNumItems=1000000));
    ```
    
    - **PySpark:**
    
    Python
    
    ```
    from delta.tables import DeltaTable
    
    delta_table = DeltaTable.forPath(spark, "deltaTableName")
    
    delta_table.createBloomFilterIndex(
        "columnName", fpp=0.01, expectedNumItems=1000000
    )
    ```
    
    Где:
    
    - `columnName` — имя столбца, для которого создается фильтр Блума.
    - `fpp` — вероятность ложноположительного срабатывания (например, 0.01 означает 1% вероятность).
    - `expectedNumItems` — ожидаемое количество уникальных значений в столбце.
2. **Удаление фильтра Блума:**
    
    - **SQL:**
    
    SQL
    
    ```
    DROP BLOOMFILTER INDEX
    ON TABLE deltaTableName
    FOR COLUMNS(columnName);
    ```
    
    - **PySpark:**
    
    Python
    
    ```
    delta_table.dropBloomFilterIndex("columnName")
    ```
    
3. **Создание фильтра Блума для нескольких столбцов:**
    
    - **SQL:**
    
    SQL
    
    ```
    CREATE BLOOMFILTER INDEX
    ON TABLE deltaTableName
    FOR COLUMNS(column1 OPTIONS (fpp=0.01, expectedNumItems=1000000), column2 OPTIONS (fpp=0.01, expectedNumItems=1000000));
    ```
    
    - **PySpark:**
    
    Python
    
    ```
    delta_table.createBloomFilterIndex(
        ["column1", "column2"], fpp=0.01, expectedNumItems=1000000
    )
    ```
    

**Ложноотрицательные срабатывания:**

- В случае фильтра Блума **ложноотрицательные срабатывания невозможны**.
- Фильтр Блума может давать только ложноположительные срабатывания.
- Если фильтр Блума говорит, что элемент отсутствует в наборе, это всегда верно.
- Если фильтр Блума говорит, что элемент присутствует в наборе, это может быть ложным срабатыванием.

**Структуры данных фильтра Блума:**

- При создании фильтра Блума Delta Lake создает дополнительные метаданные, которые хранятся вместе с данными таблицы.
- Эти метаданные включают битовый массив и набор хеш-функций.
- Метаданные хранятся в отдельных файлах, которые Delta Lake использует для фильтрации данных во время запросов.
- Количество файлов и их расположение зависят от реализации Delta Lake и конфигурации хранилища.

**Периодическое пересоздание:**

- В отличие от z-Ordering, фильтры Блума **не требуют периодического пересоздания** после изменений данных.
- Delta Lake автоматически обновляет фильтры Блума при добавлении или изменении данных.
- Однако, если кардинальность столбца значительно изменилась, может потребоваться пересоздание фильтра Блума для оптимизации его эффективности.

**Фильтры Блума для нескольких столбцов:**

- Delta Lake позволяет создавать фильтры Блума для **нескольких столбцов**.
- Это позволяет оптимизировать запросы, которые фильтруют данные по нескольким столбцам.
- Пример кода приведен выше.

**Важные замечания:**

- Фильтры Блума — это вероятностная структура данных, поэтому они могут давать ложноположительные срабатывания.
- Чем ниже значение `fpp`, тем меньше вероятность ложноположительного срабатывания, но тем больше размер фильтра Блума.
- Фильтры Блума требуют ресурсов для создания и хранения, поэтому их следует использовать только для столбцов, которые часто используются в фильтрах запросов.

Я надеюсь, это подробное объяснение поможет вам лучше понять, что такое фильтры Блума и как их использовать в Delta Lake.

## Раздельные понятия роли и пользователя

В ClickHouse начиная с версии 20.3 введена полноценная поддержка RBAC, где **роли** и **пользователи** — это отдельные сущности:

- **Пользователь (User)**:
    
    - Это учетная запись с именем и аутентификационными данными (пароль, SSL, Kerberos и т.д.), которая используется для подключения к ClickHouse.
    - Пример: `ivanov`, `petrov`.
    - Пользователь сам по себе не имеет прав — они назначаются через роли или напрямую.
- **Роль (Role)**:
    
    - Это набор привилегий, который определяет права доступа к базам данных, таблицам, словарям и другим объектам.
    - Роли могут быть назначены одному или нескольким пользователям.
    - Пример: `read_only_role`, `admin_role`.
- **Группы пользователей**:
    
    - ClickHouse не имеет явного понятия "группы пользователей" как в традиционных SQL-системах (например, MySQL), но роли выполняют аналогичную функцию. Вы можете создать роль и назначить ее нескольким пользователям, что эквивалентно группе.

---

## Ваш сценарий: создание роли и назначение пользователям

Ваш подход — создать роль с определенными правами и присвоить ее пользователям (Иванову, Петрову и т.д.) — полностью поддерживается в ClickHouse. Это эффективный способ управления доступом, особенно если у вас много пользователей с одинаковыми правами. Давайте реализуем это шаг за шагом.

### Пример: Настройка роли для доступа к базам

#### 1. Создание роли

Создайте роль с нужными привилегиями. Предположим, вы хотите дать пользователям доступ на чтение (`SELECT`) к базам `default` и `analytics`.

```sql
CREATE ROLE read_only_role;
GRANT SELECT ON default.* TO read_only_role;
GRANT SELECT ON analytics.* TO read_only_role;
```

- `read_only_role` теперь содержит права на чтение всех таблиц в базах `default` и `analytics`.

#### 2. Создание пользователей

Создайте пользователей Иванов и Петров с паролями:

```sql
CREATE USER ivanov IDENTIFIED BY 'ivanov_pass';
CREATE USER petrov IDENTIFIED BY 'petrov_pass';
```

#### 3. Назначение роли пользователям

Присвойте роль `read_only_role` пользователям Иванову и Петрову:

```sql
GRANT read_only_role TO ivanov;
GRANT read_only_role TO petrov;
```

#### 4. Проверка прав

Убедитесь, что права применены:

```sql
SHOW GRANTS FOR ivanov;
```

Вывод будет содержать что-то вроде:

```
GRANT read_only_role TO ivanov
```

Теперь Иванов и Петров имеют одинаковые права на чтение баз `default` и `analytics`.

#### 5. (Опционально) Ограничение доступа

Если нужно ограничить пользователей по IP или другим параметрам:

```sql
ALTER USER ivanov HOST IP '192.168.1.10/32';
ALTER USER petrov HOST IP '192.168.1.11/32';
```

---

## Гибкость и управление ролями

### Добавление новых привилегий

Если нужно расширить права роли (например, добавить `INSERT` для таблицы `analytics.logs`):

```sql
GRANT INSERT ON analytics.logs TO read_only_role;
```

Эти изменения автоматически применятся ко всем пользователям, которым назначена роль (`ivanov`, `petrov`).

### Отзыв роли

Если нужно убрать доступ у пользователя:

```sql
REVOKE read_only_role FROM ivanov;
```

### Создание администратора

Для управления ролями и пользователями создайте роль с правами администратора:

```sql
CREATE ROLE admin_role;
GRANT ALL PRIVILEGES ON *.* TO admin_role;
GRANT ACCESS MANAGEMENT ON *.* TO admin_role;
GRANT admin_role TO admin_user;
```

---

## Преимущества использования ролей

1. **Централизованное управление**:
    - Изменение прав в одной роли автоматически отражается на всех пользователях.
2. **Масштабируемость**:
    - Легко добавить нового пользователя (например, `sidorov`) и присвоить ему роль:
        
        ```sql
        CREATE USER sidorov IDENTIFIED BY 'sidorov_pass';
        GRANT read_only_role TO sidorov;
        ```
        
3. **Безопасность**:
    - Уменьшает риск ошибок при ручном назначении прав каждому пользователю.
4. **Группы**:
    - Роли заменяют концепцию групп, позволяя логически группировать пользователей.

---

## Проверка и мониторинг

1. **Список ролей**:
    
    ```sql
    SELECT * FROM system.roles;
    ```
    
2. **Список пользователей и их ролей**:
    
    ```sql
    SELECT user_name, roles FROM system.users;
    ```
    
3. **Логирование действий**:
    
    - Включите аудит через `system.query_log`:
        
        ```sql
        SET enable_query_log = 1;
        SELECT user, query FROM system.query_log WHERE type = 'QueryStart';
        ```
        

---

## Ограничения

- **Нет иерархии ролей**: ClickHouse не поддерживает наследование ролей (например, роль A не может включать роль B). Привилегии задаются вручную для каждой роли.
- **Конфигурация через SQL**: Роли и пользователи управляются только через SQL-команды или конфигурационные файлы (`users.xml`), что требует осторожности при редактировании.
- **Перезапуск не требуется**: Изменения применяются мгновенно, без перезапуска сервера.

---

## Рекомендации

1. **Создавайте роли для типичных сценариев**:
    
    - `read_only_role` для аналитиков.
    - `write_role` для ETL-процессов.
    - `admin_role` для администраторов.
2. **Ограничьте пользователя `default`**:
    
    - По умолчанию `default` имеет `ALL PRIVILEGES`. Ограничьте его:
        
        ```sql
        REVOKE ALL PRIVILEGES ON *.* FROM default;
        GRANT SELECT ON default.* TO default;
        ```
        
3. **Используйте конфигурацию для паролей**:
    
    - Храните пароли в `users.xml` или переменных окружения (см. предыдущие ответы), чтобы избежать их указания в SQL.
4. **Тестирование**:
    
    - Подключитесь от имени `ivanov` и выполните:
        
        ```sql
        SELECT * FROM default.my_table LIMIT 10;
        INSERT INTO default.my_table VALUES (1, 'test'); -- Должно выдать ошибку, так как только SELECT
        ```
        

---

## Заключение

В ClickHouse роли и пользователи — это отдельные понятия, и роли могут использоваться как группы для назначения прав доступа. Ваш подход — создать роль с правами (например, `read_only_role`) и присвоить ее пользователям (Иванов, Петров) — полностью реализуем. Это позволяет централизованно управлять доступом и упрощает добавление новых пользователей. Используйте команды `CREATE ROLE`, `GRANT`, и `REVOKE` для настройки, а также проверяйте права через системные таблицы (`system.users`, `system.roles`).

Если у вас есть конкретный список баз, таблиц или прав, могу предложить более детальную конфигурацию.
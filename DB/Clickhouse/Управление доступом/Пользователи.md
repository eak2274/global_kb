## Пользователь и база данных — это одно и то же?

Нет, в ClickHouse **пользователь** и **база данных** — это разные понятия:

- **Пользователь (User)**:
    
    - Это учетная запись, которая используется для подключения к ClickHouse.
    - Пользователь идентифицируется по имени и паролю (или другим методам аутентификации, например, через SSL или Kerberos).
    - Пример: пользователь `default` — стандартный пользователь, создаваемый при установке ClickHouse.
- **База данных (Database)**:
    
    - Это логическая сущность, которая содержит таблицы, словари, представления и другие объекты.
    - Пример: база данных `default` — стандартная база, создаваемая при установке ClickHouse.
- **Связь между ними**:
    
    - Пользователи получают доступ к базам данных через права, которые задаются с помощью SQL-команд (`GRANT`, `REVOKE`) или через конфигурационные файлы.
    - Пользователь `default` не обязательно привязан к базе данных `default` — это просто совпадение имен. Пользователь `default` может иметь доступ к любой базе данных, если ему предоставлены соответствующие права.

---

## Возможные уровни доступа к базе данных

ClickHouse использует систему управления доступом на основе ролей (RBAC), которая позволяет гибко настраивать права пользователей. Уровни доступа определяются через привилегии, которые можно назначать пользователям или ролям.

### Типы привилегий

Вот основные привилегии, которые можно назначить для базы данных (например, `default`):

1. **SELECT**:
    
    - Доступ на чтение данных из таблиц (выполнение `SELECT`-запросов).
    - Пример:
        
        ```sql
        GRANT SELECT ON default.* TO user1;
        ```
        
2. **INSERT**:
    
    - Право на вставку данных в таблицы.
    - Пример:
        
        ```sql
        GRANT INSERT ON default.* TO user1;
        ```
        
3. **ALTER**:
    
    - Право на изменение структуры таблиц (например, `ALTER TABLE`, добавление/удаление столбцов).
    - Пример:
        
        ```sql
        GRANT ALTER ON default.* TO user1;
        ```
        
4. **CREATE**:
    
    - Право на создание новых объектов (таблиц, словарей, представлений) в базе данных.
    - Пример:
        
        ```sql
        GRANT CREATE ON default.* TO user1;
        ```
        
5. **DROP**:
    
    - Право на удаление объектов (например, `DROP TABLE`).
    - Пример:
        
        ```sql
        GRANT DROP ON default.* TO user1;
        ```
        
6. **TRUNCATE**:
    
    - Право на очистку таблиц (`TRUNCATE TABLE`).
    - Пример:
        
        ```sql
        GRANT TRUNCATE ON default.* TO user1;
        ```
        
7. **SHOW**:
    
    - Право на просмотр метаданных (например, `SHOW TABLES`, `SHOW CREATE TABLE`).
    - Пример:
        
        ```sql
        GRANT SHOW ON default.* TO user1;
        ```
        
8. **ACCESS MANAGEMENT**:
    
    - Право на управление пользователями и ролями (например, `CREATE USER`, `GRANT`, `REVOKE`).
    - Обычно предоставляется администраторам.
    - Пример:
        
        ```sql
        GRANT ACCESS MANAGEMENT ON *.* TO admin_user;
        ```
        
9. **ALL PRIVILEGES**:
    
    - Полный доступ ко всем привилегиям на указанную базу данных.
    - Пример:
        
        ```sql
        GRANT ALL PRIVILEGES ON default.* TO user1;
        ```
        

### Гранулярность доступа

- Права можно назначать на уровне:
    - ВСЕХ баз данных: `ON *.*` (например, `GRANT SELECT ON *.* TO user1`).
    - Конкретной базы данных: `ON default.*` (все таблицы в базе `default`).
    - Конкретной таблицы: `ON default.my_table`.

---

## Пользователь `default` и база `default`

### Пользователь `default`

- Пользователь `default` создается автоматически при установке ClickHouse.
- По умолчанию он имеет полный доступ ко всем базам данных и таблицам (привилегия `ALL PRIVILEGES ON *.*`), если не изменена конфигурация.
- Вы можете ограничить права пользователя `default`:
    
    ```sql
    REVOKE ALL PRIVILEGES ON *.* FROM default;
    GRANT SELECT, INSERT ON default.* TO default;
    ```
    
    Теперь `default` сможет только читать и вставлять данные в базу `default`.

### Доступ к базе `default`

- База `default` — это стандартная база данных, но доступ к ней не ограничен только пользователем `default`.
- Вы можете создать других пользователей и предоставить им доступ к базе `default`.

#### Пример: Создание нового пользователя

1. Создайте пользователя `job_user`:
    
    ```sql
    CREATE USER job_user IDENTIFIED BY 'job_password';
    ```
    
2. Предоставьте ограниченный доступ к базе `default`:
    
    ```sql
    GRANT SELECT ON default.* TO job_user;
    ```
    
    Теперь `job_user` может только читать данные из базы `default`.
    
3. (Опционально) Создайте роль для управления доступом:
    
    ```sql
    CREATE ROLE reader;
    GRANT SELECT ON default.* TO reader;
    GRANT reader TO job_user;
    ```
    

---

## Может ли быть только один пользователь?

Нет, в ClickHouse **не обязательно** использовать только пользователя `default`. Вы можете:

- Создавать новых пользователей с разными уровнями доступа.
- Использовать роли для группировки прав и упрощения управления.
- Ограничить пользователя `default` или даже отключить его для повышения безопасности.

### Пример: Настройка нескольких пользователей

1. Создайте пользователя для чтения:
    
    ```sql
    CREATE USER readonly_user IDENTIFIED BY 'readonly_pass';
    GRANT SELECT ON default.* TO readonly_user;
    ```
    
2. Создайте администратора:
    
    ```sql
    CREATE USER admin_user IDENTIFIED BY 'admin_pass';
    GRANT ALL PRIVILEGES ON *.* TO admin_user;
    ```
    
3. Ограничьте `default`:
    
    ```sql
    REVOKE ALL PRIVILEGES ON *.* FROM default;
    GRANT SELECT ON default.* TO default;
    ```
    

Теперь у вас три пользователя с разными уровнями доступа:

- `readonly_user`: только чтение.
- `admin_user`: полный доступ.
- `default`: ограниченный доступ (только чтение).

---

## Проверка прав доступа

1. Посмотрите текущих пользователей:
    
    ```sql
    SELECT * FROM system.users;
    ```
    
2. Посмотрите права пользователя:
    
    ```sql
    SHOW GRANTS FOR job_user;
    ```
    
    Вывод, например: `GRANT SELECT ON default.* TO job_user`.
    
3. Проверьте роли:
    
    ```sql
    SELECT * FROM system.roles;
    SHOW GRANTS FOR reader;
    ```
    

---

## Рекомендации для продакшена

1. **Ограничьте пользователя `default`**:
    
    - Не используйте его для продакшен-доступа, так как он по умолчанию имеет полные права.
    - Создайте отдельных пользователей с минимальными необходимыми привилегиями.
2. **Используйте роли**:
    
    - Группируйте права в роли для упрощения управления.
    - Пример: роль `reader` для пользователей, которым нужно только чтение.
3. **Храните пароли безопасно**:
    
    - Используйте хэшированные пароли:
        
        ```sql
        CREATE USER job_user IDENTIFIED WITH sha256_password BY 'job_password';
        ```
        
    - Или настройте учетные данные через конфигурацию (`users.xml`), как описано в предыдущих примерах.
4. **Логирование**:
    
    - Включите аудит действий пользователей через `system.query_log`:
        
        ```sql
        SELECT user, query FROM system.query_log WHERE type = 'QueryStart';
        ```
        
5. **Ограничьте доступ по IP**:
    
    - В конфигурации пользователя можно указать разрешенные сети:
        
        ```sql
        CREATE USER job_user IDENTIFIED BY 'job_password' HOST IP '192.168.1.0/24';
        ```
        

---

## Заключение

- **Пользователь** и **база данных** в ClickHouse — это разные сущности. Пользователь `default` не привязан к базе `default`, это просто стандартное имя.
- Вы можете создавать сколько угодно пользователей и предоставлять им разные уровни доступа к базе `default` (или другим базам) через привилегии (`SELECT`, `INSERT`, `CREATE`, и т.д.).
- Пользователь `default` по умолчанию имеет полные права, но их можно ограничить. Вы можете добавить других пользователей (например, `job_user`) с минимальными правами, такими как только чтение.
- Для управления доступом используйте роли, ограничения по IP и безопасное хранение паролей.

Если у вас есть конкретный сценарий (например, настройка прав для нескольких пользователей или интеграция с внешними системами), могу предложить более детальную конфигурацию.
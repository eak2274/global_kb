
## Возможность ограничения доступа к конкретным объектам

В ClickHouse вы можете предоставлять права доступа (например, `SELECT`, `INSERT`, `ALTER`) не ко всей базе данных (`database.*`), а только к конкретным объектам внутри нее, таким как таблицы, словари или представления. Это достигается через синтаксис команды `GRANT`, где указываются имена конкретных объектов.

---

## Синтаксис и примеры

### 1. Доступ к конкретной таблице

Вы можете предоставить права только на определенную таблицу в базе данных.

#### Пример

Предположим, база данных называется `default`, и в ней есть таблицы `users` и `orders`. Вы хотите дать пользователю `ivanov` право на чтение (`SELECT`) только таблицы `users`.

```sql
GRANT SELECT ON default.users TO ivanov;
```

- Теперь `ivanov` может выполнять `SELECT` только для таблицы `default.users`, но не для `default.orders`.

#### Проверка

```sql
SELECT * FROM system.grants WHERE user_name = 'ivanov';
```

Вывод покажет только привилегию `SELECT` на `default.users`.

---

### 2. Доступ к нескольким конкретным таблицам

Если нужно дать доступ к нескольким таблицам, перечислите их через запятую.

#### Пример

Дайте пользователю `petrov` права на чтение (`SELECT`) таблиц `users` и `orders`:

```sql
GRANT SELECT ON default.users, default.orders TO petrov;
```

- `petrov` получит доступ только к этим двум таблицам, но не к другим объектам в `default`.

---

### 3. Доступ к столбцам таблицы

Вы можете ограничить доступ до уровня отдельных столбцов внутри таблицы.

#### Пример

Дайте пользователю `ivanov` право на чтение только столбцов `id` и `name` таблицы `users`:

```sql
GRANT SELECT(id, name) ON default.users TO ivanov;
```

- Теперь `ivanov` сможет выполнять `SELECT id, name FROM default.users`, но не сможет получить доступ к другим столбцам (например, `email`).

#### Проверка

```sql
SELECT * FROM system.grants WHERE user_name = 'ivanov';
```

Вывод покажет привилегию `SELECT` с указанием столбцов `id, name`.

---

### 4. Доступ к словарям

Если вы работаете со словарями (например, `default_users_dict`), можете предоставить права на конкретный словарь.

#### Пример

Дайте пользователю `petrov` право на использование словаря `default_users_dict`:

```sql
GRANT DICTIONARY ON default.default_users_dict TO petrov;
```

- `petrov` сможет использовать функции вроде `dictGet` с этим словарем, но не с другими.

---

### 5. Комбинирование прав

Вы можете комбинировать разные привилегии для разных объектов.

#### Пример

Дайте пользователю `ivanov` право на чтение таблицы `users` и вставку в таблицу `orders`:

```sql
GRANT SELECT ON default.users, INSERT ON default.orders TO ivanov;
```

- `ivanov` сможет читать `users` и вставлять данные в `orders`, но не сможет выполнять другие действия (например, `ALTER` или `DROP`).

---

## Отзыв прав с конкретных объектов

Чтобы убрать доступ к конкретному объекту, используйте команду `REVOKE`.

#### Пример

Отзовите право `SELECT` на таблицу `users` у пользователя `ivanov`:

```sql
REVOKE SELECT ON default.users FROM ivanov;
```

- Теперь `ivanov` потеряет доступ к `default.users`, но сохранит другие привилегии (если они есть).

---

## Использование ролей для управления доступом

Для удобства можно создать роль с правами на конкретные объекты и назначить ее пользователям.

#### Пример

1. Создайте роль `limited_access_role`:
    
    ```sql
    CREATE ROLE limited_access_role;
    GRANT SELECT ON default.users, INSERT ON default.orders TO limited_access_role;
    ```
    
2. Назначьте роль пользователям:
    
    ```sql
    GRANT limited_access_role TO ivanov;
    GRANT limited_access_role TO petrov;
    ```
    
3. Проверка:
    
    ```sql
    SELECT user_name, role_name, access_type, database, table
    FROM system.grants
    WHERE role_name = 'limited_access_role';
    ```
    

- Теперь оба пользователя (`ivanov` и `petrov`) имеют одинаковые права на `users` и `orders`.

---

## Проверка прав через системные таблицы

Как упоминалось ранее, используйте `system.grants` для анализа:

```sql
SELECT
    user_name,
    role_name,
    access_type,
    database,
    table,
    column
FROM system.grants
WHERE user_name = 'ivanov' OR role_name IN (
    SELECT roles FROM system.users WHERE name = 'ivanov'
);
```

- Это покажет все права `ivanov`, включая те, что унаследованы через роли.

---

## Ограничения

1. **Только объектный доступ**:
    - Права можно назначать только на существующие объекты. Если таблица удалена, права автоматически отменяются.
2. **Нет шаблонов**:
    - ClickHouse не поддерживает шаблоны типа `default.users_*` для массового назначения прав на таблицы с общим префиксом.
3. **Ручное управление**:
    - При добавлении новых таблиц нужно вручную обновлять права.

---

## Рекомендации

1. **Используйте роли**:
    
    - Создавайте роли для типичных наборов прав и назначайте их пользователям, чтобы избежать дублирования команд `GRANT`.
2. **Ограничьте права по умолчанию**:
    
    - Убедитесь, что пользователь `default` не имеет `ALL PRIVILEGES`:
        
        ```sql
        REVOKE ALL PRIVILEGES ON *.* FROM default;
        ```
        
3. **Тестирование**:
    
    - Подключитесь от имени пользователя и проверьте доступ:
        
        ```sql
        SELECT * FROM default.users LIMIT 10; -- Должно работать
        SELECT * FROM default.orders LIMIT 10; -- Должно выдать ошибку, если нет прав
        ```
        
4. **Аудит**:
    
    - Регулярно проверяйте права через `system.grants`:
        
        ```sql
        SELECT * FROM system.grants WHERE database = 'default';
        ```
        

---

## Заключение

В ClickHouse вы можете дать доступ на выполнение определенных действий только к перечню конкретных объектов (таблиц, столбцов, словарей) с помощью команды `GRANT`, указывая имена объектов вместо `database.*`. Это позволяет точно контролировать доступ, ограничивая пользователей конкретными таблицами (например, `default.users`) или столбцами. Использование ролей упрощает управление, позволяя назначать один набор прав нескольким пользователям. Если у вас есть список конкретных объектов или сценарий, могу предложить более детальную конфигурацию.
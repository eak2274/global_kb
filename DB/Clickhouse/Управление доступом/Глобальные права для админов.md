
## Особенности прав на управление пользователями и ролями

В ClickHouse управление пользователями и ролями — это административные действия, которые выполняются на уровне всей системы, а не конкретной базы данных. Это связано с тем, что пользователи и роли — это глобальные сущности, которые применяются ко всем базам данных на сервере. Основная привилегия, которая регулирует эти действия, — это `ACCESS MANAGEMENT`.

### Что дает `ACCESS MANAGEMENT`?

- Разрешает создание, изменение и удаление пользователей (`CREATE USER`, `ALTER USER`, `DROP USER`).
- Разрешает создание, изменение и удаление ролей (`CREATE ROLE`, `ALTER ROLE`, `DROP ROLE`).
- Разрешает назначение и отзыв прав и ролей (`GRANT`, `REVOKE`).
- Позволяет управлять настройками пользователей (например, `ALTER USER ... SETTINGS`).

### Не привязка к конкретной базе

- Поскольку пользователи и роли — это глобальные сущности, привилегия `ACCESS MANAGEMENT` применяется на уровне всей системы (`ON *.*`).
- Даже если вы укажете `ACCESS MANAGEMENT ON default.*`, это не ограничит действия по управлению пользователями и ролями только базой `default`, так как эти действия не связаны с конкретной базой. Указание `ON default.*` в данном случае игнорируется системой, и привилегия действует глобально.

---

## Назначение прав на управление пользователями и ролями

### 1. Предоставление права `ACCESS MANAGEMENT`

Чтобы пользователь мог создавать и управлять пользователями и ролями, ему нужно предоставить привилегию `ACCESS MANAGEMENT` на уровне всей системы:

#### Пример

Создадим пользователя `admin_user` и дадим ему права на управление доступом:

```sql
CREATE USER admin_user IDENTIFIED BY 'admin_pass';
GRANT ACCESS MANAGEMENT ON *.* TO admin_user;
```

- Теперь `admin_user` может:
    - Создавать пользователей:
        
        ```sql
        CREATE USER new_user IDENTIFIED BY 'new_pass';
        ```
        
    - Создавать роли:
        
        ```sql
        CREATE ROLE new_role;
        ```
        
    - Назначать права:
        
        ```sql
        GRANT SELECT ON default.* TO new_user;
        ```
        
    - Назначать роли:
        
        ```sql
        GRANT new_role TO new_user;
        ```
        

#### Примечание

- Указание `ON *.*` означает, что привилегия действует на всю систему. Это стандартный способ предоставления административных прав.
- Если вы попытаетесь указать `ON default.*`, ClickHouse проигнорирует ограничение по базе, так как `ACCESS MANAGEMENT` — это глобальная привилегия.

---

### 2. Ограничение административных действий

ClickHouse не позволяет ограничить `ACCESS MANAGEMENT` конкретной базой данных, но вы можете:

#### Использовать роли для частичного контроля

Создайте роль с ограниченными правами и управляйте доступом через нее:

```sql
CREATE ROLE access_admin;
GRANT ACCESS MANAGEMENT ON *.* TO access_admin;
GRANT access_admin TO admin_user;
```

- Это позволяет централизованно управлять административными правами.

#### Ограничить другие действия

Хотя `ACCESS MANAGEMENT` действует глобально, вы можете ограничить другие права `admin_user`, чтобы он не мог взаимодействовать с данными:

```sql
REVOKE ALL PRIVILEGES ON *.* FROM admin_user;
GRANT ACCESS MANAGEMENT ON *.* TO admin_user;
```

- Теперь `admin_user` может управлять пользователями и ролями, но не имеет прав на чтение, запись или создание таблиц.

---

## Проверка прав

### Через `system.grants`

Посмотрите назначенные права:

```sql
SELECT
    user_name,
    access_type,
    database,
    table
FROM system.grants
WHERE user_name = 'admin_user';
```

#### Пример вывода:

|user_name|access_type|database|table|
|---|---|---|---|
|admin_user|ACCESS MANAGEMENT|*|*|

- Здесь видно, что `admin_user` имеет только `ACCESS MANAGEMENT` на уровне всей системы.

### Через `SHOW GRANTS`

```sql
SHOW GRANTS FOR admin_user;
```

#### Пример вывода:

```
GRANT ACCESS MANAGEMENT ON *.* TO admin_user
```

---

## Тестирование

1. Подключитесь от имени `admin_user` и попробуйте создать пользователя:
    
    ```sql
    CREATE USER test_user IDENTIFIED BY 'test_pass';
    ```
    
    - Успешно.
2. Попробуйте создать роль и назначить права:
    
    ```sql
    CREATE ROLE test_role;
    GRANT SELECT ON default.* TO test_role;
    ```
    
    - Успешно.
3. Попробуйте выполнить запрос к данным (без соответствующих прав):
    
    ```sql
    SELECT * FROM default.users;
    ```
    
    - Ошибка: `admin_user` не имеет права `SELECT`.

---

## Ограничения

1. **Глобальность `ACCESS MANAGEMENT`**:
    
    - Нельзя ограничить управление пользователями или ролями конкретной базой данных, так как эти сущности глобальны.
2. **Нет разделения действий**:
    
    - `ACCESS MANAGEMENT` предоставляет все административные функции (создание, изменение, удаление). Нельзя, например, разрешить только `CREATE USER`, но запретить `DROP USER`.
3. **Риск чрезмерных прав**:
    
    - Пользователь с `ACCESS MANAGEMENT` может предоставить себе любые права через `GRANT`, если не ограничен другими мерами (например, через `WITH ADMIN OPTION`).

---

## Рекомендации

1. **Минимизируйте права**:
    
    - Давайте `ACCESS MANAGEMENT` только тем пользователям, которым это действительно нужно.
    - Ограничивайте другие права:
        
        ```sql
        REVOKE ALL PRIVILEGES ON *.* FROM admin_user;
        GRANT ACCESS MANAGEMENT ON *.* TO admin_user;
        ```
        
2. **Используйте `WITH ADMIN OPTION`**:
    
    - Если хотите, чтобы пользователь мог управлять ролями, но не передавать их другим:
        
        ```sql
        GRANT ACCESS MANAGEMENT ON *.* TO admin_user;
        ```
        
    - Без `WITH ADMIN OPTION` (по умолчанию) пользователь не сможет передавать административные права другим.
3. **Логирование действий**:
    
    - Отслеживайте действия через `system.query_log`:
        
        ```sql
        SELECT user, query FROM system.query_log WHERE query LIKE '%CREATE USER%' OR query LIKE '%GRANT%' LIMIT 10;
        ```
        
4. **Проверка**:
    
    - Регулярно проверяйте, кто имеет административные права:
        
        ```sql
        SELECT * FROM system.grants WHERE access_type = 'ACCESS MANAGEMENT';
        ```
        

---

## Заключение

Права на создание и управление пользователями и ролями в ClickHouse выдаются через привилегию `ACCESS MANAGEMENT`, которая действует на уровне всей системы (`ON *.*`) и не может быть ограничена конкретной базой данных, так как пользователи и роли — это глобальные сущности. Для управления используйте команды `GRANT` и `REVOKE`, а для безопасности минимизируйте права и отслеживайте действия через системные таблицы. Если у вас есть конкретный сценарий (например, настройка ограничений для администратора), могу предложить более детальную конфигурацию.
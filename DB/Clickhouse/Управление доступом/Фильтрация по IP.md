## Возможность ограничения доступа

ClickHouse позволяет:

1. Предоставить доступ только к определенным столбцам таблицы с помощью команды `GRANT SELECT(column1, column2)`.
2. Ограничить доступ пользователя по диапазону IP-адресов с помощью параметра `HOST` при создании или изменении пользователя.

Эти два механизма можно комбинировать, чтобы создать точное управление доступом.

---

## Пошаговая настройка

### 1. Предоставление доступа к определенным столбцам

Предположим, у вас есть таблица `default.users` с колонками `id`, `name`, и `email`. Вы хотите дать пользователю доступ только к столбцам `id` и `name`.

#### Создание пользователя

Создайте пользователя `job_user`:

```sql
CREATE USER job_user IDENTIFIED BY 'job_password';
```

#### Назначение прав на столбцы

Дайте доступ только к столбцам `id` и `name` таблицы `users`:

```sql
GRANT SELECT(id, name) ON default.users TO job_user;
```

- Теперь `job_user` сможет выполнять запросы вроде:
    
    ```sql
    SELECT id, name FROM default.users;
    ```
    
- Но попытка выбрать `email` вызовет ошибку:
    
    ```sql
    SELECT email FROM default.users; -- Ошибка: недостаточно прав
    ```
    

---

### 2. Ограничение доступа по диапазону IP-адресов

Теперь ограничьте доступ пользователя `job_user` так, чтобы он мог подключаться только с определенного диапазона IP-адресов, например, `192.168.1.0/24`.

#### Настройка ограничения по IP

Используйте параметр `HOST` при создании или изменении пользователя:

```sql
ALTER USER job_user HOST IP '192.168.1.0/24';
```

- Теперь `job_user` сможет подключиться к ClickHouse только с IP-адресов в диапазоне `192.168.1.0/24` (например, `192.168.1.10`, но не `10.0.0.1`).

#### Варианты настройки `HOST`

- Указание конкретного IP:
    
    ```sql
    ALTER USER job_user HOST IP '192.168.1.10';
    ```
    
- Несколько диапазонов:
    
    ```sql
    ALTER USER job_user HOST IP '192.168.1.0/24', IP '10.0.0.0/8';
    ```
    
- Разрешение только локальных подключений:
    
    ```sql
    ALTER USER job_user HOST LOCAL;
    ```
    
- Разрешение любых IP (по умолчанию):
    
    ```sql
    ALTER USER job_user HOST ANY;
    ```
    

---

### 3. Комбинирование: столбцы + IP

Вы можете создать пользователя с ограничением по столбцам и IP в одном сценарии:

#### Пример полного создания

```sql
CREATE USER job_user
IDENTIFIED BY 'job_password'
HOST IP '192.168.1.0/24';

GRANT SELECT(id, name) ON default.users TO job_user;
```

- `job_user` сможет:
    - Подключаться только с IP из диапазона `192.168.1.0/24`.
    - Выполнять `SELECT id, name FROM default.users`.

---

### 4. Использование ролей (опционально)

Если у вас несколько пользователей с одинаковыми правами, используйте роли:

#### Создание роли

```sql
CREATE ROLE column_access_role;
GRANT SELECT(id, name) ON default.users TO column_access_role;
```

#### Назначение роли пользователям

```sql
CREATE USER job_user IDENTIFIED BY 'job_password' HOST IP '192.168.1.0/24';
GRANT column_access_role TO job_user;
```

- Теперь `job_user` наследует права роли и ограничение по IP.

---

## Проверка настроек

### Проверка прав

```sql
SELECT
    user_name,
    access_type,
    database,
    table,
    column
FROM system.grants
WHERE user_name = 'job_user';
```

#### Пример вывода:

|user_name|access_type|database|table|column|
|---|---|---|---|---|
|job_user|SELECT|default|users|id|
|job_user|SELECT|default|users|name|

### Проверка ограничений по IP

```sql
SELECT name, host_ip FROM system.users WHERE name = 'job_user';
```

#### Пример вывода:

|name|host_ip|
|---|---|
|job_user|['192.168.1.0/24']|

---

## Тестирование

1. Подключитесь от имени `job_user` с разрешенного IP (`192.168.1.10`):
    
    ```sql
    SELECT id, name FROM default.users; -- Успешно
    SELECT email FROM default.users; -- Ошибка: недостаточно прав
    ```
    
2. Попробуйте подключиться с другого IP (например, `10.0.0.1`):
    
    - Ошибка: `Connection refused: user 'job_user' is not allowed to connect from this IP`.

---

## Ограничения

1. **Точность ограничений**:
    - Права на столбцы работают только для `SELECT`. Для других операций (`INSERT`, `ALTER`) права на столбцы не поддерживаются.
2. **IP-ограничения**:
    - Если IP клиента динамический, это может вызвать проблемы. Рассмотрите использование VPN или более широкого диапазона.
3. **Отсутствие шаблонов**:
    - Нельзя указать права на столбцы по шаблону (например, `SELECT(name*)`).

---

## Рекомендации

1. **Используйте роли**:
    
    - Если у вас несколько пользователей с одинаковыми ограничениями, создавайте роли для упрощения управления.
2. **Шифрование соединений**:
    
    - Настройте SSL для защиты данных при передаче:
        
        ```sql
        ALTER USER job_user SETTINGS ssl = true;
        ```
        
3. **Логирование**:
    
    - Отслеживайте попытки подключения через `system.query_log`:
        
        ```sql
        SELECT user, client_ip, query
        FROM system.query_log
        WHERE type = 'QueryStart' AND user = 'job_user';
        ```
        
4. **Мониторинг прав**:
    
    - Регулярно проверяйте права через `system.grants`:
        
        ```sql
        SELECT * FROM system.grants WHERE table = 'users';
        ```
        

---

## Заключение

ClickHouse позволяет предоставить доступ только к определенным столбцам таблицы (например, `id` и `name` в `default.users`) с помощью `GRANT SELECT(column1, column2)`, а также ограничить подключение по диапазону IP-адресов через параметр `HOST`. Эти два механизма можно комбинировать, создавая точные правила доступа для пользователей или ролей. Проверяйте настройки через системные таблицы (`system.grants`, `system.users`) и тестируйте доступ с разных IP.

Если у вас есть конкретный список столбцов, таблиц или IP-диапазонов, могу предложить более детальную конфигурацию.